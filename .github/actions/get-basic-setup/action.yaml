name: Get basic setup

inputs:
  account_id:
    required: false
  app_id:
    required: true
  private_key:
    required: true
  region:
    required: false

outputs:
  account_id:
    description: Id of the AWS account we are deploying to
    value: ${{ steps.get-account-id.outputs.value }}
  bucket:
    description: Central administration bucket
    value: ${{ steps.get-bucket-name.outputs.bucket }}
  region:
    description: AWS region we are deploying to
    value: ${{ steps.get-region.outputs.value }}
  token:
    description: Token to use for GitHub calls
    value: ${{ steps.app-token.outputs.token}}

runs:
  using: composite
  steps:

    - name: Create Github app token
      id: app-token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ inputs.app_id }}
        private-key: ${{ inputs.private_key }}
        owner: ${{ github.repository_owner }}

    - name: Get account id
      id: get-account-id
      uses: stormreply/storm-library-for-terraform/.github/actions/get-repository-variable@main
      with:
        repository: stormreply/storm-library-for-terraform
        token: ${{ steps.app-token.outputs.token}}
        use_if_set: ${{ inputs.account_id }}
        variable: ACCOUNT_ID

    - name: Get region
      id: get-region
      uses: stormreply/storm-library-for-terraform/.github/actions/get-repository-variable@main
      with:
        repository: stormreply/storm-library-for-terraform
        token: ${{ steps.app-token.outputs.token}}
        use_if_set: ${{ inputs.region }}
        variable: REGION

    - name: Get bucket name
      id: get-bucket-name
      uses: stormreply/storm-library-for-terraform/.github/actions/get-bucket-name@main
      with:
        account_id: ${{ steps.get-account-id.outputs.value }}
