name: Prepare repository

inputs:
  environment:
    required: true
  release:
    required: true

outputs:
  # deployment:
  #   value: ${{ steps.create_github_tfvars.outputs.deployment }}
  repository:
    value: ${{ steps.create_github_tfvars.outputs.repository }}

runs:
  using: "composite"
  steps:

    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      shell: bash
      run: echo "$GITHUB_CONTEXT"

    - name: Create github tfvars
      id: create_github_tfvars
      shell: bash
      run: |
        # github_repo="${github_repository##*/}"
        # deployment_name="storm-${github_repo}-${{ inputs.environment }}"
        # echo "deployment=${ deployment_name }"     >> $GITHUB_OUTPUT
        echo "repository=${{ github.repository }}" >> $GITHUB_OUTPUT

        cat << EOF >> github.tfvars
        deployment = {
          actor       = "${{ github.actor }}"
          environment = "${{ inputs.environment }}"
          name        = "${  deployment_name }"
          ref         = "${{ github.ref }}"
          ref_name    = "${{ github.ref_name }}"
          release     = "${{ inputs.release }}"
          repository  = "${{ github.repository }}"
          sha         = "${{ github.sha }}"
          time        = "$(  date )"
        }
        EOF

        echo $GITHUB_OUTPUT
        cat  $GITHUB_OUTPUT

        ls -la

        cat github.tfvars