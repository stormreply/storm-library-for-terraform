name: Set token

runs:
  using: composite
  steps:

    - name: create github app token
      if: env.TERRAFORM_APP_ID != '' && env.TERRAFORM_PRIVATE_KEY != ''
      id: create-github-app-token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ env.TERRAFORM_APP_ID }}
        private-key: ${{ env.TERRAFORM_PRIVATE_KEY }}
        owner: ${{ github.repository_owner }}

    - name: set Token
      id: set-token
      shell: bash
      run: |
        # set-environment/from-others/set-token

        type="Github App Token" # so far
        token="${{ steps.create-github-app-token.outputs.token }}"

        if [ -n "${{ env.PERSONAL_ACCESS_TOKEN }}" ] ; then
          token=${{ env.PERSONAL_ACCESS_TOKEN }}
          type="Personal Access Token"
        fi

        if [ -z "${token}" ] ; then
          token=${{ env.GITHUB_TOKEN }}
          type="GITHUB_TOKEN"
        fi

        if [ ${#token} -eq 0 ] ; then
          echo "::error title=No valid token::could not get a token"
          exit 1
        fi

        echo "::notice ::using your $type as token"

        cat << EOF | tee -a $GITHUB_ENV
        TOKEN=$token
        TOKEN_TYPE=$type
        EOF
