name: Set environment from others

inputs:
  private_access_token:
    required: false
  terraform_private_key:
    required: false

runs:
  using: composite
  steps:

    - name: set token
      if: inputs.private_access_token != '' || inputs.terraform_private_key != ''
      id: set-token
      uses: stormreply/storm-library-for-terraform/.github/actions/set-environment/from-others/set-token@main
      with:
        private_access_token: ${{ inputs.private_access_token }}
        terraform_private_key: ${{ inputs.terraform_private_key }}

    - name: set backend bucket
      if: env.BACKEND_ACCOUNT != ''
      id: set-backend-bucket
      uses: stormreply/storm-library-for-terraform/.github/actions/set-environment/from-others/set-backend-bucket@main

    - name: get deployment name
      id: get-deployment-name
      uses: stormreply/storm-library-for-terraform/.github/actions/set-environment/from-others/set-deployment-name@main

    - name: get state file
      id: get-state-file
      uses: stormreply/storm-library-for-terraform/.github/actions/get/state-file@main
      with:
        deployment_name: ${{ steps.get-deployment-name.outputs.name }}

    - name: set env from others
      id: set-environment-from-others
      shell: bash
      run: |
        # set-environment/from-others

        BACKEND_BUCKET="${{ steps.get-backend-bucket.outputs.backend_bucket}}"
        DEPLOYMENT_NAME="${{ steps.get-deployment-name.outputs.name }}"
        STATE_FILE="${{ steps.get-state-file.outputs.state_file }}"
        TOKEN="${{ steps.get-token.outputs.token }}"

        # TEMPORARILY
        DEPLOYMENT_ACCOUNT=${{ env.BACKEND_ACCOUNT }}
        DEPLOYMENT_REGION=${{ env.BACKEND_REGION }}
        # TEMPORARILY

        cat << EOF >> $GITHUB_ENV
        BACKEND_BUCKET=$BACKEND_BUCKET
        BACKEND_ROLE=slt-0-storm-library-for-terraform-backend
        DEPLOYMENT_ACCOUNT=$DEPLOYMENT_ACCOUNT
        DEPLOYMENT_NAME=$DEPLOYMENT_NAME
        DEPLOYMENT_REGION=$DEPLOYMENT_REGION
        DEPLOYMENT_ROLE=slt-0-storm-library-for-terraform-deployment
        STATE_FILE=$STATE_FILE
        TOKEN=$TOKEN
        EOF
