name: Get vars

inputs:
  yaml:
    required: true

outputs:
  access_domain:
    value: ${{ steps.get-vars.outputs.access_domain }}
  access_role:
    value: ${{ steps.get-vars.outputs.access_role }}
  backend_account:
    value: ${{ steps.get-vars.outputs.backend_account }}
  backend_bucket:
    value: ${{ steps.get-backend-bucket.outputs.backend_bucket }}
  backend_region:
    value: ${{ steps.get-vars.outputs.backend_region }}
  deployment_account:
    value: ${{ steps.get-vars.outputs.backend_account }} # TODO:
  deployment_name:
    value: ${{ steps.get-deployment-name.outputs.name }}
  deployment_region:
    value: ${{ steps.get-vars.outputs.backend_region }} # TODO:
  environment:
    value: ${{ steps.get-vars.outputs.environment }}
  oidc_principal:
    value: ${{ steps.get-vars.outputs.oidc_principal }}
  state_file:
    value: ${{ steps.get-state-file.outputs.state_file }}
  token:
    value: ${{ steps.get-token.outputs.token }}

runs:
  using: composite
  steps:

    - name: Get vars
      id: get-vars
      shell: bash
      run: |
        # get/vars

        yaml="${{ inputs.yaml }}"
        echo "[$yaml]"
        IFS=$'\n' lines=($yaml)
        for l in "${lines[@]}" ; do
          key=${l%%:*}
          val=${l##*: }
          if [ -n "$val" ] ; then
            # echo "$key=$val" | tee -a $GITHUB_OUTPUT
            echo "$key=$val" >> $GITHUB_OUTPUT
            # echo "$key=$val" >> $GITHUB_ENV
          else
            [ "$key" = "private_access_token" ]  && continue
            [ "$key" = "terraform_private_key" ] && continue
            echo "ERROR: $key is empty. exiting."
            exit 1
          fi
        done

    - name: Get Token
      if: inputs.get_token == true
      id: get-token
      uses: stormreply/storm-library-for-terraform/.github/actions/get/token@main
      with:
        private_access_token: ${{ inputs.private_access_token }}
        terraform_app_id: ${{ steps.get-vars.outputs.terraform_app_id }}
        terraform_private_key: ${{ inputs.terraform_private_key }}

    - name: Get backend bucket
      if: steps.get-vars.outputs.backend_account != ''
      id: get-backend-bucket
      uses: stormreply/storm-library-for-terraform/.github/actions/get/backend-bucket@main
      with:
        backend_account: ${{ steps.get-vars.outputs.backend_account }}

    - name: Get deployment name
      id: get-deployment-name
      uses: stormreply/storm-library-for-terraform/.github/actions/get/deployment-name@main
      with:
        environment: ${{ steps.get-vars.outputs.environment }}
        token: ${{ steps.get-token.outputs.token}}

    - name: Get state file
      id: get-state-file
      uses: stormreply/storm-library-for-terraform/.github/actions/get/state-file@main
      with:
        deployment_name: ${{ steps.get-deployment-name.outputs.name }}

    - name: Show vars
      id: show-vars
      shell: bash
      run: |
        # show-vars
        pat="${{ steps.get-vars.outputs.private_access_token }}"
        tpk="${{ steps.get-vars.outputs.terraform_private_key }}"

        echo "${{ toJSON(steps.get-vars.outputs) }}"
        has_pat=$(echo "${{ toJSON(steps.get-vars.outputs) }}" | jq '(.private_access_token // "") | length > 0')
        has_tpk=$(echo "${{ toJSON(steps.get-vars.outputs) }}" | jq '(.terraform_private_key // "") | length > 0')

        echo "access domain:         ${{ steps.get-vars.outputs.access_domain }}"
        echo "access role:           ${{ steps.get-vars.outputs.access_role }}"
        echo "backend account:       ${{ steps.get-vars.outputs.backend_account }}"
        echo "backend region:        ${{ steps.get-vars.outputs.backend_region }}"
        echo "deployment account:    ${{ steps.get-vars.outputs.backend_account }}"
        echo "deployment region:     ${{ steps.get-vars.outputs.backend_region }}"
        echo "environment:           ${{ steps.get-vars.outputs.environment }}"
        echo "oidc principal:        ${{ steps.get-vars.outputs.oidc_principal }}"
        echo "terraform app id:      ${{ steps.get-vars.outputs.terraform_app_id }}"
        echo
        echo "backend bucket:        ${{ steps.get-backend-bucket.outputs.backend_bucket}}"
        echo "deployment name:       ${{ steps.get-deployment-name.outputs.name }}"
        echo "state file:            ${{ steps.get-state-file.outputs.state_file }}"
        echo
        echo "has private access token:  ${has_pat}, length: ${#pat}"
        echo "has terraform private key: ${has_tpk}, length: ${#tpk}"
