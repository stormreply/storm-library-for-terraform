name: Prepare

inputs:

  backend_account:
    required: true
  backend_bucket:
    required: false # init workflow only
  backend_region:
    required: true
  deployment_name:
    required: true
  environment:
    required: true
  oidc_principal:
    required: false # init workflow only
  token:
    required: true

runs:
  using: composite
  steps:

    # - name: Dump GitHub context
    #   env:
    #     GITHUB_CONTEXT: ${{ toJson(github) }}
    #   shell: bash
    #   run: echo "$GITHUB_CONTEXT"

    # TODO: move to very beginning of each workflow
    # - name: Time
    #   shell: bash
    #   run: date

    - name: Checkout repository
      uses: actions/checkout@v4

    # NOTE: important to position *behind* checkout
    - name: Git config rewrite URLs
      shell: bash
      run: |
        # Git config rewrite URLs
        TOKEN=${{ inputs.token }}
        git config --global url."https://x-access-token:$TOKEN@github.com/".insteadOf "https://github.com/"
        # git config --global url."https://x-access-token:$TOKEN@github.com/".insteadOf "git@github.com:"

        echo "global .gitconfig:"
        cat ~/.gitconfig
        echo "local .git/config:"
        cat .git/config

    - name: Download providers.tf
      uses: stormreply/storm-library-for-terraform/.github/actions/download@main
      with:
        token: ${{ inputs.token }}
        file: providers.tf

    - name: set init.tfvars
      if: inputs.oidc_principal != ''
      uses: stormreply/storm-library-for-terraform/.github/actions/set/init-tfvars@main
      with:
        backend_bucket: ${{ inputs.backend_bucket }}
        oidc_principal: ${{ inputs.oidc_principal }}

    - name: Set github.tfvars
      uses: stormreply/storm-library-for-terraform/.github/actions/set/github-tfvars@main
      with:
        deployment_name: ${{ inputs.deployment_name }}
        environment: ${{ inputs.environment }}

    - name: Set AWS profiles # TODO: move out
      uses: stormreply/storm-library-for-terraform/.github/actions/set/aws/profiles@main
      with:
        backend_account: ${{ inputs.backend_account }}
        backend_region: ${{ inputs.backend_region }}
        backend_role: slt-0-storm-library-for-terraform-backend
        deployment_account: ${{ inputs.backend_account }} # TODO:
        deployment_region: ${{ inputs.backend_region }} # TODO:
        deployment_role: slt-0-storm-library-for-terraform-deployment
        use_oidc: ${{ inputs.oidc_principal == '' }}
